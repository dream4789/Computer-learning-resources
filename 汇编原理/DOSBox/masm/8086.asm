DATA SEGMENT
  CS8259A EQU 8000H
  CS8259B EQU 8002H
  ICW1 EQU 00010011B
  ICW2 EQU 00100000B
  ICW4 EQU 00000001B
  OCW1 EQU 00111111B
  ;8253
  CNT0 EQU 9000H
  CNT1 EQU 9002H
  CNT2 EQU 9004H
  CTL  EQU 9006H
  ;8255
  A_PORT EQU 0A000H
  B_PORT EQU 0A002H
  C_PORT EQU 0A004H
  CT_PORT EQU 0A006H
  FLAG DW 20
  TAB DB 3FH,06H,5BH,4FH,66H,6DH,7DH,07H,7FH,67H,77H,7CH,39H,5EH,79H,71H
DATA ENDS

STACK SEGMENT STACK
  STA DB 512 DUP(0FFH)
  TOP EQU $-STA
STACK ENDS

CODE SEGMENT PUBLIC 'CODE'
  ASSUME CS:CODE,DS:DATA,SS:STACK
  ORG 100H
START:
  MOV AX,DATA
  MOV DS,AX
  MOV AX,STACK
  MOV SS,AX
  MOV AX,TOP
  MOV SP,AX
  CLI
  PUSH DS
  MOV AX,0
  MOV DS,AX
  MOV BX,156
  MOV AX,OFFSET INT7
  MOV [BX],AX
  MOV AX,0
  MOV [BX+2],AX
  POP DS
  PUSH DS
  MOV AX,0
  MOV DS,AX
  MOV BX,26H*4
  MOV AX,OFFSET INT6
  MOV [BX],AX 
  MOV AX,0
  MOV [BX+2],AX
  POP DS
  
  ;8259初始化
  MOV DX,CS8259A
  MOV AL,ICW1
  OUT DX,AL
  MOV DX,CS8259B
  MOV AL,ICW2
  OUT DX,AL
  MOV AL,ICW4
  OUT DX,AL
  MOV AL,OCW1
  OUT DX,AL
  STI
  
  ;8255初始化
  MOV AL,80H
  MOV DX,CT_PORT
  OUT DX,AL
  MOV AL,00
  MOV DX,A_PORT
  OUT DX,AL
  
  ;8253初始化
  MOV DX,CTL
  MOV AL,00110110B
  OUT DX,AL
  MOV DX,CNT0
  MOV AX,1000
  OUT DX,AL
  MOV AL,AH
  OUT DX,AL
  MOV DX,CTL
  MOV AL,01110110B
  OUT DX,AL
  MOV DX,CNT1
  MOV AX,1000
  OUT DX,AL
  MOV AL,AH
  OUT DX,AL

LP:
  NOP
  STI
  JMP LP

INT6:  
  CLI
  PUSH AX
  PUSH BX
  PUSH CX
  PUSH DX
  STI
  MOV DX,A_PORT
  MOV AL,00001001B
  OUT DX,AL
  MOV CX,5
  
NEXT:
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,B_PORT
  OUT DX,AL
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,C_PORT
  OUT DX,AL
  CALL DELAY100
  LOOP NEXT
  MOV DX,CS8259A
  MOV AL,20H
  OUT DX,AL
  CLI
  POP DX
  POP CX
  POP BX
  POP AX
  OUT DX,AL
  STI
  IRET

;延时程序
DELAY100 PROC
  PUSH CX
  MOV CX,0
  LOOP $
  LOOP $
  LOOP $
  MOV CX,15000
  LOOP $
  POP CX
  RET
DELAY100 ENDP

INT7:   
  CLI  
  PUSH AX
  PUSH BX
  PUSH CX
  PUSH DX
  MOV CX,FLAG
  CMP CX,0
  JG B0
  MOV FLAG,20

B0:
  DEC FLAG
  CMP CX,10
  JAE A0
  CMP CX,3
  JBE B1
  MOV AL,00010001B
  MOV DX,A_PORT
  OUT DX,AL
  JMP LEDB

B1:
  MOV AL,00100001B
  MOV DX,A_PORT
  OUT DX,AL
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,C_PORT
  OUT DX,AL
  MOV DX,B_PORT
  OUT DX,AL
  JMP EXIT

LEDB: 
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,B_PORT
  OUT DX,AL
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,C_PORT
  OUT DX,AL
  JMP EXIT

A0:
  SUB CX,10
  CMP CX,3
  JBE A1
  MOV AL,00001010B
  MOV DX,A_PORT
  OUT DX,AL
  JMP LEDA

A1:
  MOV AL,00001100B
  MOV DX,A_PORT
  OUT DX,AL
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,C_PORT
  OUT DX,AL
  MOV DX,B_PORT
  OUT DX,AL
  JMP EXIT

LEDA:   
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,C_PORT
  OUT DX,AL
  LEA BX,TAB
  ADD BX,CX
  MOV AL,[BX]
  MOV DX,B_PORT
  OUT DX,AL

EXIT:
  MOV DX,CS8259A
  MOV AL,20H
  OUT DX,AL
  CLI
  POP DX
  POP CX
  POP BX
  POP AX
  STI
  IRET
CODE ENDS
  END START
