<!DOCTYPE html>
<html lang="en">

	<head>
		<meta http-equiv="Access-Control-Allow-Origin" content="*" />
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
		<title>班级管理</title>
	</head>

	<body>
		<div id='app'>
			<h3>班级管理系统</h3>
			<hr>
			<el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px"
				class="demo-ruleForm">
				<el-form-item label="用户名" prop="adm">
					<el-input placeholder="请输入用户名" style="width: 300px;" type="text" v-model="ruleForm.adm"
						autocomplete="off"></el-input>
				</el-form-item>
				<el-form-item label="密码" prop="pass">
					<el-input placeholder="请输入密码" style="width: 300px;" type="password" v-model="ruleForm.pass"
						autocomplete="off"></el-input>
				</el-form-item>
				<el-form-item>
					<el-button type="primary" @click="submitForm('ruleForm')">登录</el-button>
					<el-button @click="resetForm('ruleForm')">重置</el-button>
				</el-form-item>

				<!-- 				<router-link :to="{path:'/home'}">
				<router-view></router-view> -->
			</el-form>

			<hr>

			<el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px"
				class="demo-ruleForm">
				<el-form-item label="用户名" prop="adm">
					<el-input placeholder="请输入用户名" style="width: 300px;" type="text" v-model="ruleForm.adm"
						autocomplete="off"></el-input>
				</el-form-item>
				<el-form-item label="密码" prop="pass">
					<el-input placeholder="请输入密码" style="width: 300px;" type="password" v-model="ruleForm.pass"
						autocomplete="off"></el-input>
				</el-form-item>
				<el-form-item label="确认密码" prop="checkPass">
					<el-input placeholder="请再次输入密码" style="width: 300px;" type="password" v-model="ruleForm.checkPass"
						autocomplete="off">
					</el-input>
				</el-form-item>
				<el-form-item>
					<el-button type="primary" @click="registerdata('ruleForm')">注册</el-button>
					<el-button @click="resetForm('ruleForm')">重置</el-button>

				</el-form-item>


			</el-form>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
		<!-- 引入组件库 -->
		<script src="https://unpkg.com/element-ui/lib/index.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script>
			// axios.defaults.withCredentials = false;
			axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
			// axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*'

			//基础url
			axios.defaults.baseURL = "http://localhost:3000"; // 不设置就会访问 8848 端口的 /api

			var instance = axios.create({
					// baseURL: "http://127.0.0.1:3000",
					timeout: 5000,
					// headers: {
					// 	'Access-Control-Allow-Origin': '*',
					// 	'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'
					// }
					headers: { // 设置请求头(请求头名字可以随便起，但只能传token)
						'Authorization': localStorage.getItem("userToken"),
						// 'authorization': localStorage.getItem("userToken"),
						'token': localStorage.getItem("userToken"),
					},
				})

				
				// 添加请求拦截器
				// instance.interceptors.request.use(function(config) {
				// 	// Do something before request is sent
				// 	let token = window.localStorage.getItem("userToken")
				// 	if (token) {
				// 		// config.headers.token = token; //将token放到请求头发送给服务器
				// 		config.headers.Authorization = localStorage.getItem("userToken");
				// 		return config;
				// 		//这里经常搭配token使用，将token值配置到tokenkey中，将tokenkey放在请求头中
				// 		// config.headers['token'] = Token;
				// 	}
				// }, function(error) {
				// 	return Promise.reject(error);
				// });
				

				new Vue({
					el: "#app",
					data() {
						var adminPass = (rule, value, callback) => {
							if (!value) {
								return callback(new Error('用户名不能为空'));
							} else if (value.lenght > 16 || value.lenght < 3) {
								return callback(new Error('用户名长度必须是3~16位'));
							}
							// setTimeout(() => {
							// 	if (!Number.isInteger(value)) {
							// 		callback(new Error('请输入数字值'));
							// 	} else {
							// 		if (value < 18) {
							// 			callback(new Error('必须年满18岁'));
							// 		} else {
							// 			callback();
							// 		}
							// 	}
							// }, 1000);
						}
						var validatePass = (rule, value, callback) => {
							if (value === '') {
								callback(new Error('请输入密码'));
							} else if (value.lenght > 16 || value.lenght < 6) {
								return callback(new Error('密码必须是6~16位字符'));
							} else if (!value.match(/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]/)) {
								return callback(new Error('包含字符、数字和 _'));
							} else {
								if (this.ruleForm.checkPass !== '') {
									this.$refs.ruleForm.validateField('checkPass');
								}
								callback();
							}
						}
						var validatePass2 = (rule, value, callback) => {
							if (value === '') {
								callback(new Error('请再次输入密码'));
							} else if (value !== this.ruleForm.pass) {
								callback(new Error('两次输入密码不一致!'));
							} else {
								callback();
							}
						}
						return {
							ruleForm: {
								adm: '', // v-model一样
								pass: '',
								checkPass: ''
							},
							rules: {
								adm: [{ // prop一样
									validator: adminPass, // 规则
									trigger: 'blur'
								}],
								pass: [{
									validator: validatePass,
									trigger: 'blur'
								}],
								checkPass: [{
									validator: validatePass2,
									trigger: 'blur'
								}]
							},
							admin: '',
							password: '',

						}
					},
					created() {
						// this.getClassList();
					},
					methods: {
						async submitForm(formName) {
							this.$refs[formName].validate((valid) => {
								// console.log(valid); // 布尔 只对adm有效
								if (valid) {
									console.log('submit!');
								} else {
									console.log('error submit!!');
									return false;
								}
							});

							// 要传输的参数
							const data = new URLSearchParams();
							data.append('nickname', this.ruleForm.adm);
							data.append('password', this.ruleForm.pass);

							console.log('======', data);

							const res = await instance.post('/admin/login', data)

							console.log('登录后端返回信息:', res.data.msg);
							// if (res.response.status == 401) {
							// 	console.log('账号或密码错误！');
							// }
							// console.log('后端返回信息:', res.data.message, ' -- ', res.data.msg);
							// 失败：{name: 'ValidationError', message: '用户名长度必须是3~16位', request: 'POST /admin/register'}
							// 成功：{msg: 'success', errorCode: 1, code: 200, data: {…}}

							console.log('登录后端返回信息2:', res);
							if (res.data.code !== 200) {
								this.$message({
									type: 'error',
									message: '登录 ' + res.data.msg
								});
							} else {
								this.$message({
									type: 'success',
									message: '登录 ' + res.data.msg
								});
							}

							// localStorage 存 token
							const token = res.data.data.token;
							localStorage.setItem("userToken", token);



							const res_get = await instance.get('/admin/user/info').then(res => {
								console.log('token===', res)
							}).catch(err => {
								console.log('err===', err)
							})


							// this.$router.push({path:'/admin/user/info', query: {id:'123456'}})

							// this.$router.replace('/admin/user/info');
							// const redirect = this.$route.redirect || "/admin/user/info";
							// this.$router.push(redirect);


							// console.log('查询！！！')
							// const res1 = await instance.post('/admin/user/info')
						},

						async registerdata(formName) {
							this.$refs[formName].validate((valid) => {
								// console.log(valid); // 布尔 只对adm有效
								if (valid) {
									console.log('submit!');
								} else {
									console.log('error submit!!');
									return false;
								}
							});

							// 要传输的参数
							const data = new URLSearchParams();
							data.append('nickname', this.ruleForm.adm);
							data.append('password', this.ruleForm.pass);
							data.append('password2', this.ruleForm.checkPass);

							console.log(data);

							const res1 = await instance.post('/admin/register', data)

							console.log('注册后端返回信息:', res1);
							// 失败：{name: 'ValidationError', message: '用户名长度必须是3~16位', request: 'POST /admin/register'}
							// 成功：{msg: 'success', errorCode: 1, code: 200, data: {…}}

							if (res1.data.code !== 200) {
								this.$message({
									type: 'error',
									message: '注册 ' + res1.data.msg
								});
							} else {
								this.$message({
									type: 'success',
									message: '注册 ' + res1.data.msg
								});
							}
						},

						resetForm(formName) {
							this.$refs[formName].resetFields(); // 对整个表单进行重置，将所有字段值重置为初始值并移除校验结果
						},

					}
				})
		</script>
	</body>

</html>
